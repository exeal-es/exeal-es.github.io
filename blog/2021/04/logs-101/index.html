<!doctype html><html lang=es><head><meta charset=utf-8><title>Logs 101 | Exeal</title><meta name=description content="Breve introducción a técnicas de logging, cómo escribir logs útiles que faciliten la tarea de diagnóstico de incidencias en aplicaciones software."><meta name=author content="Exeal"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:title" content="Logs 101"><meta property="og:description" content="Breve introducción a técnicas de logging, cómo escribir logs útiles que faciliten la tarea de diagnóstico de incidencias en aplicaciones software."><meta property="og:type" content="article"><meta property="og:url" content="https://www.exeal.com/blog/2021/04/logs-101/"><meta property="og:image" content="https://www.exeal.com/assets/img/blog/posts/logs.jpg"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-04-07T00:10:00+01:00"><meta property="article:modified_time" content="2021-04-07T00:10:00+01:00"><meta itemprop=name content="Logs 101"><meta itemprop=description content="Breve introducción a técnicas de logging, cómo escribir logs útiles que faciliten la tarea de diagnóstico de incidencias en aplicaciones software."><meta itemprop=datePublished content="2021-04-07T00:10:00+01:00"><meta itemprop=dateModified content="2021-04-07T00:10:00+01:00"><meta itemprop=wordCount content="883"><meta itemprop=image content="https://www.exeal.com/assets/img/blog/posts/logs.jpg"><meta itemprop=keywords content="logs,bugs,netcore,csharp,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.exeal.com/assets/img/blog/posts/logs.jpg"><meta name=twitter:title content="Logs 101"><meta name=twitter:description content="Breve introducción a técnicas de logging, cómo escribir logs útiles que faciliten la tarea de diagnóstico de incidencias en aplicaciones software."><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css integrity=sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm crossorigin=anonymous><link rel=stylesheet href=https://www.exeal.com/scss/main.css><link rel=icon type=image/png href=/assets/img/favicon.png><link rel=apple-touch-icon href=/assets/img/apple-touch-icon.png><script async src="https://www.googletagmanager.com/gtag/js?id=UA-172984297-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-172984297-1")</script><script type=text/javascript id=hs-script-loader async defer src=//js.hs-scripts.com/8231847.js></script>
<link rel=stylesheet type=text/css href=https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css><meta name=facebook-domain-verification content="xwbugjbpmp2jwy1y6mzdhe6ga267uz"><script>!function(t,o,i,a,e,n,s){if(t.fbq)return;e=t.fbq=function(){e.callMethod?e.callMethod.apply(e,arguments):e.queue.push(arguments)},t._fbq||(t._fbq=e),e.push=e,e.loaded=!0,e.version="2.0",e.queue=[],n=o.createElement(i),n.async=!0,n.src=a,s=o.getElementsByTagName(i)[0],s.parentNode.insertBefore(n,s)}(window,document,"script","https://connect.facebook.net/en_US/fbevents.js"),fbq("init","417415780749470"),fbq("track","PageView")</script><noscript><img height=1 width=1 style=display:none src="https://www.facebook.com/tr?id=417415780749470&ev=PageView&noscript=1"></noscript><link rel=stylesheet href=https://www.exeal.com/scss/blog.css><link rel=stylesheet href=https://www.exeal.com/scss/hero.css></head><body><nav class="navbar navbar-light navbar-expand-lg navbar-shrink"><div class=container><div class="d-flex flex-row"><a href=/ class=navbar-brand><img src=/assets/img/logo-exeal-header-black.svg alt=Exeal></a>
<a href=/blog/ class=navbar-brand><img src=/assets/img/blog/logo-blog.svg alt=Blog></a></div><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarTogglerDemo01 aria-controls=navbarTogglerDemo01 aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarTogglerDemo01><ul class="navbar-nav ml-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Servicios</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=/servicios/technical-coaching/>Coaching técnico</a>
<a class=dropdown-item href=/servicios/aceleradora-de-talento/>Aceleradora de talento</a>
<a class=dropdown-item href=/cursos/>Formaciones a medida</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdownResources role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Recursos</a><div class=dropdown-menu aria-labelledby=navbarDropdownResources><a class=dropdown-item href=https://academia.exeal.com/collections>Cursos gratuitos</a>
<a class=dropdown-item href=/lista-de-correo/>Lista de correo</a>
<a class=dropdown-item href=/blog/>Blog</a>
<a class=dropdown-item href=/katas/>Katas</a></div></li><li class=nav-item><a class="nav-link nav-button" href=/lista-de-correo/>Suscríbete</a></li></ul></div></div></nav><header class="hero hero-bg-img" style=background-image:url(/assets/img/blog/posts/logs.jpg)><div class="hero-bg-img-mask bg-mask"><div class="container h-100"><div class="row h-100 align-items-center"><div class="col-12 text-center"><ul class="tags tags-light"><li><a href=https://www.exeal.com/tags/logs/>#logs</a></li><li><a href=https://www.exeal.com/tags/bugs/>#bugs</a></li><li><a href=https://www.exeal.com/tags/netcore/>#netcore</a></li><li><a href=https://www.exeal.com/tags/csharp/>#csharp</a></li></ul><h1><span class=underline>Logs 101</span></h1><h2>Pedro Pardal</h2><p class=date>2021/04/07</p><p><a data-scroll=sect-body href=#><img class=arrow-down src=/assets/img/arrow-down-secondary.svg></a></p></div></div></div></div></header><section id=sect-body><div class=container><article><p>Recientemente en el equipo con el que trabajo, hemos tenido varias incidencias que han sido bastante difíciles de depurar. Los principales motivos son los siguientes:</p><ul><li>No hay logs</li><li>Los logs que hay no son útiles</li></ul><p>A raíz de esto preparé una learning hour sobre el tema, cuyo contenido ha acabado convirtiéndose en este post. Vamos a revisitar conceptos basicos de logging, explicar los factores necesarios para que los logs sean útiles, y aclarar algunos conceptos erróneos.</p><p>Este post no pretende ser una guía exhaustiva, sino una breve introducción llena de links a los que profundizar más sobre cada tema.</p><h2 id=por-qué-logar>¿Por qué logar?</h2><p>Los logs son la ventana a los internals de nuestra aplicación. Sin ellos no podemos saber qué está pasando dentro. Si hay un error, una vez ya ha pasado, o ha dejado información o no podemos saber qué ha pasado.</p><h2 id=dónde-logar>¿Dónde logar?</h2><p>Lo más sencillo es volcar información a la salida estándar: <code>console.log(message)</code> ya es un log. Sin embargo en entornos más complejos este enfoque se queda corto. Otras salidas pueden ser:</p><ul><li>Salida estándar</li><li>Ficheros</li><li>Base de datos</li><li>Sistema de logs centralizados (ELK, Graylog, etc.)</li></ul><p>Los sistemas de logs centralizados nos permiten agregar los logs de todas las aplicaciones para detectar errores más fácilmente en una arquitectura distribuida (múltiples microservicios, cloud&mldr;), además de indexar los logs para optimizar su filtrado, configurar alarmas, etc.</p><h2 id=logamos-antes-o-después>¿Logamos antes o después?</h2><p>Preferiblemente, <strong>logar después</strong>. En otro caso, para saber si ha ido bien, tienes que buscar <a href=https://tuhrig.de/my-logging-best-practices/>si NO hay una excepción</a>.
O en todo caso, logar antes+después, pero nunca logar antes solo.</p><h2 id=en-qué-ocasiones-debemos-logar>¿En qué ocasiones debemos logar?</h2><p>En las siguientes ocasiones (no es una lista exhaustiva):</p><ul><li>Resultado de una request</li><li>Información relevante para negocio</li><li>Algo no ha ido como esperabamos</li><li>El código entra en flujos de control especiales (caso base - no hay nada que procesar)</li><li>Errores</li></ul><h2 id=log-levels>Log levels</h2><p>¿Con qué nivel logo?</p><ul><li><code>DEBUG/TRACE</code>: cosas de developers</li><li><code>INFO</code>: cosas de negocio</li><li><code>WARNING</code>: algo no ha ido como esperabamos pero todo sigue funcionando, pero hay que mirarlo.</li><li><code>ERROR</code>: algo hay ido mal / no se ha hecho y hay que mirarlo ASAP / alertar.</li></ul><p><code>WARN</code> y <code>ERROR</code> son <strong>calls to action</strong>, i.e. deberíamos hacer algo cuando veamos alguno.</p><h2 id=qué-loglevel-tiene-que-estar-activo>¿Qué loglevel tiene que estar activo?</h2><ul><li>En entornos de producción: <code>INFO</code>, porque son cosas relevantes para negocio.</li><li>En entornos de desarrollo: <code>DEBUG</code>.</li><li>En entornos locales si es necesario: <code>TRACE</code>.</li></ul><h2 id=qué-información-debemos-logar>¿Qué información debemos logar?</h2><ul><li>Mensaje descriptivo</li><li>Nivel del error</li><li>Contexto: ¿quién está logando? (ya que luego querremos filtrar logs)</li><li>Valores de las variables relevantes</li></ul><h3 id=anatomía-de-una-linea-de-log>Anatomía de una linea de log</h3><p>Para responder a la pregunta de qué campos tiene que llevar una linea de log, debemos responder antes a la siguiente pregunta: ¿Cómo vamos a usar los logs?</p><p>El uso más común cuando estamos diagnosticando una incidencia es <strong>filtrar</strong>. ¿Cómo podemos estructurar nuestras líneas de forma que podamos llegar a la información que queremos lo antes posible? Depende de los escenarios nos podamos encontrar.</p><p>Algunos escenarios de ejemplo:</p><ul><li>Dame todos los logs de todas las ejecuciones de un cronjob: necesito el category/tag/source context</li><li>Dame todos los logs de una llamada de varios servicios: necesito un correlation id</li><li>Dame todas las ejecuciones de una línea de código en concreto: necesito que el mensaje de log sea fijo</li><li>Dame todos los logs de un id relevante (p.ej un orderId, paymentId o similar): necesito pushear la property en el contexto<ul><li>Dependerá del framework de logging que estamos usando.</li><li>En la práctica es especialmente útil para diagnosticar problemas con un third party en el que nos proporcionan un id externo.</li></ul></li></ul><p>Campos de ejemplo:</p><ul><li>Timestamp</li><li>LogLevel</li><li>SourceContext (Tag/Category)</li><li>Mensaje</li><li>?Properties</li><li>?Excepción</li></ul><h2 id=structured-logging>Structured logging</h2><p>El <a href=https://stackify.com/what-is-structured-logging-and-why-developers-need-it/>structured logging</a> es una técnica que consiste en separar los datos que se logan del propio mensaje del log, facilitando que el log sea parseable. Especialmente útil si enviamos los logs a un backend como ElasticSearch, para facilitar su indexación y posterior filtrado.</p><p>La mayoría de librerías hoy en día facilitan la tarea de escribir líneas de log estructuradas.</p><h3 id=structured-logging-en-net-con-serilog>Structured logging en .NET con Serilog</h3><p>Ejemplo de structured logging con <a href=https://benfoster.io/blog/serilog-best-practices>Serilog</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>Log.Debug(<span style=color:#e6db74>&#34;Disk quota {Quota} exceeded by user {Username}&#34;</span>, <span style=color:#ae81ff>100</span>, <span style=color:#e6db74>&#34;DTI-Matt&#34;</span>);
</span></span></code></pre></div><p>También podemos añadir propiedades extra para logar en todas las lineas de log dentro de un scope de forma sencilla:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> (LogContext.PushProperty(<span style=color:#e6db74>&#34;RequestId&#34;</span>, Request.Id))
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Log.Information(<span style=color:#e6db74>&#34;Adding {Item} to cart {CartId}&#34;</span>, item, cart.Id);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=canonical-log-lines>Canonical log lines</h2><p>Son <a href=https://stripe.com/blog/canonical-log-lines>líneas de log especiales</a> que registran el resultado de cada request. Contiene:</p><ul><li>Path</li><li>Status code</li><li>Algunos headers relevantes</li><li>Duración de la request</li></ul><p>Ejemplo de una canonical log line:
<code>[2019-03-18 22:48:32.999] canonical-log-line alloc_count=9123 auth_type=api_key database_queries=34 duration=0.009 http_method=POST http_path=/v1/charges http_status=200 key_id=mk_123 permissions_used=account_write rate_allowed=true rate_quota=100 rate_remaining=99 request_id=req_123 team=acquiring user_id=usr_123</code></p><h3 id=qué-puedo-hacer-con-ellas>¿Qué puedo hacer con ellas?</h3><p>Una de las cosas más útiles es extraer las <a href=https://www.weave.works/blog/the-red-method-key-metrics-for-microservices-architecture/>Métricas RED</a>:</p><ul><li>R (request Rate): contar todas las responses con SourceContext: CanonicalLogging</li><li>E (request Errors): contar todas las responses erróneas (status >= 400)</li><li>D (request Duration): agregados de la duración de las requests</li></ul><p>Podemos construir dashboard que permitan visualizar esta información con herramientas como Kibana/Grafana:</p><ul><li>Volumetría de peticiones</li><li>Picos de errores</li><li>Picos de latencia</li></ul><p>Adicionalmente, puedo configurar alertas sobre estos dashboards para alertar sobre situaciones anómalas (caída en la volumetría, picos de errores/latencia, etc.)</p><h2 id=correlation>Correlation</h2><p>Si un use case se implementa con llamadas entre varios servicios, ¿cómo obtengo una traza de todo el call stack distribuido?</p><ul><li>Correlation id</li><li>Que todas las llamadas lo envíen</li></ul></article></div><div class=container><div class="row h-100 align-items-center"><div class="col-12 text-center"><ul class="tags tags-dark"><li><a href=https://www.exeal.com/tags/logs/>#logs</a></li><li><a href=https://www.exeal.com/tags/bugs/>#bugs</a></li><li><a href=https://www.exeal.com/tags/netcore/>#netcore</a></li><li><a href=https://www.exeal.com/tags/csharp/>#csharp</a></li></ul><div class=post-author><img class=rounded-circle src=/assets/img/team/pedropardal.jpg><div class=post-author-name><h2>Pedro Pardal</h2><p>Founder, Software Craftsman & Technical Coach</p><ul class="social-icons list-inline"><li class=list-inline-item><a target=_blank href=https://twitter.com/ppardalj><img src=/assets/img/blog/social-icons/icon-twitter.svg></a></li><li class=list-inline-item><a target=_blank href=https://www.linkedin.com/in/pedro-pardal-jimena-36764344/><img src=/assets/img/blog/social-icons/icon-linkedin.svg></a></li><li class=list-inline-item><a target=_blank href=https://github.com/ppardalj><img src=/assets/img/blog/social-icons/icon-github.svg></a></li><li class=list-inline-item><a target=_blank href=mailto:pedro.pardal@exeal.com><img src=/assets/img/blog/social-icons/icon-email.svg></a></li></ul></div></div><div class=addthis_inline_share_toolbox></div></div></div></div></section><footer class=black><div class=container><div class="row align-items-center"><div class="col-lg-6 text-lg-left"><a href=/><img src=/assets/img/logo-exeal-footer.svg alt=Exeal></a><p><a href=/equipo/>Equipo</a> |
<a href=/jobs/extreme-programming-coach/>Empleo</a> |
<a href=/legal/legal-notice/>Aviso legal</a> |
<a href=/legal/cookie-policy/>Política de cookies</a> |
<a href=/legal/privacy-policy/>Política de privacidad</a></p></div><div class="col-lg-6 social-media"><ul class="list-inline text-lg-right mt-3 mt-lg-0"><li class=list-inline-item><a target=_blank href=https://twitter.com/exeal><img src=/assets/img/social/twitter.svg></a></li><li class=list-inline-item><a target=_blank href=https://www.linkedin.com/company/exeal/><img src=/assets/img/social/linkedin.svg></a></li><li class=list-inline-item><a target=_blank href=https://www.youtube.com/channel/UCxVspi-mashFr1RPGxSxEPA><img src=/assets/img/social/youtube.svg></a></li><li class=list-inline-item><a target=_blank href=https://github.com/exeal-es><img src=/assets/img/social/github.svg></a></li><li class=list-inline-item><a target=_blank href=mailto:hola@exeal.com><img src=/assets/img/social/email.svg></a></li></ul></div></div></div></footer><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js integrity=sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q crossorigin=anonymous></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js integrity=sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl crossorigin=anonymous></script>
<script src=/assets/js/scroll.js></script>
<script src=/assets/js/redirect.js></script>
<script src=/assets/js/console.js></script>
<script>function loadScript(t){var n=document.getElementsByTagName("head")[0],e=document.createElement("script");e.type="text/javascript",e.src="https://tracker.metricool.com/resources/be.js",e.onreadystatechange=t,e.onload=t,n.appendChild(e)}loadScript(function(){beTracker.t({hash:"45d30dfb71957d625ad900e4772a2d6a"})})</script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5f2bf2edad69c454"></script></body></html>